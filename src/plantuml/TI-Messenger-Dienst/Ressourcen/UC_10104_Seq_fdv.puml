/' 
# TI-Messenger 1.1
# TI-Messenger-Dienst
# UC - 10104
# Sequence Diagram
# Name: Einladung von Akteuren innerhalb einer Organisation
'/

@startuml
skinparam sequenceMessageAlign direction
skinparam minClassWidth 200
skinparam BoxPadding 1
skinparam sequenceReferenceHeaderBackgroundColor palegreen
scale max 2048 width

skinparam sequence {
ArrowColor black
ArrowFontSize 17
ActorBorderColor black
LifeLineBorderColor black
LifeLineBackgroundColor Gainsboro

ParticipantBorderColor Motivation
ParticipantBackgroundColor Motivation
ParticipantFontName Impact
ParticipantFontSize 20
ParticipantFontColor black
ParticipantBorderColor Black
ParticipantBackgroundColor MOTIVATION

ActorBackgroundColor Gainsboro
ActorFontColor black
ActorFontSize 20
ActorFontName Aapex
}
    actor U1 as "Akteur - A"
    participant C1 as "TI-Messenger-\nClient A" #AliceBlue
    box <size:18>Messenger-Service</size> #WhiteSmoke
      participant MP as "Messenger-\nProxy"
      participant MH as "Matrix-\nHomeserver"
    end box
    participant C2 as "TI-Messenger-\nClient B" #AliceBlue
    actor U2 as "Akteur - B"
    
|||
note over U1, U2: \n<size:17>Die Akteure sind auf dem selben Messenger-Service angemeldet und im Besitz eines zugelassenen TI-Messenger-Clients.\n<size:17>Ein Chatraum wurde durch den Einladenen eingerichtet.</size>\n
|||
    U1->C1: Akteur B einladen
    activate C1
    C1->MP: POST  /_matrix/client/v3/rooms/{roomId}/invite
    activate MP
    |||
      MP->MP: Prüfe auf Föderationszugehörigkeit
      MP->MP: <font color=red> <b>NEU: Prüfe auf Versichertenzugehörigkeit 
    |||
    
    alt#LightGrey #LightPink <size:16>Matrix-Domain nicht in der Föderation enthalten</size>
      |||
      MP-->C1: HTTP 401 \nUnauthorized
      |||
      C1-->U1: Einladung nicht \nerfolgreich
      |||
    
      else <size:16>Matrix-Domain in der Föderation enthalten & beide Akteure sind Versicherte</size>
      |||
      MP-->C1: HTTP 401 \nUnauthorized
      |||
      C1-->U1: Einladung nicht \nerfolgreich
      |||

      else #AliceBlue <size:16>Matrix-Domain in der Föderation enthalten und nur maximal einer der Akteure ist Versicherter
      MP->MH: HTTP(S) Foward
        activate MH
      MH->MH: Invite verarbeiten
      |||
          MH-->MP: Invite Request
          MP->C2: HTTP(S) Forward
            activate C2 
          C2->U2: Einladung anzeigen
          U2-->C2: Einladung annehmen
          C2-->MP: Einladung angenommen
          deactivate C2
          |||
          MP->MH: HTTP(S) Forward
          MH-->MP: Status
            deactivate MH
          MP-->C1: Status
          deactivate MP
          C1-->U1: Nutzer in den \nRaum hinzugefügt
          deactivate C1
        |||
        end
 |||
@enduml
