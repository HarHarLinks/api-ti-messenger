name: Lint JSON Schema

env:
  SCHEMAS_ROOT: src/schema
  EXAMPLES_ROOT: src/schema/examples

runs:
  using: "composite"
  steps:
    - name: Set up check-jsonschema
      shell: bash
      run: |
        pip install check-jsonschema

    - name: Verify schemas
      shell: bash
      run: |
        # We handle the return code ourselves to prevent the action from exiting on the first error
        rc=0

        while read -r file; do
          echo "Validating $file"
          if ! check-jsonschema --check-metaschema "$file"; then
            rc=1
          fi
        done < <(find "${{ env.SCHEMAS_ROOT }}" -name "*.json" -maxdepth 1)

        exit $rc

    - name: Verify examples
      shell: bash
      run: |
        # We handle the return code ourselves to prevent the action from exiting on the first error
        rc=0

        while read -r file; do
          schema=$(basename "$file")
          schema=${{ env.SCHEMAS_ROOT }}/${schema%%.*}.json
          echo "Validating $file against $schema"
          if ! check-jsonschema --schemafile "$schema" "$file"; then
            rc=1
          fi
        done < <(find "${{ env.EXAMPLES_ROOT }}" -name "*.json")

        exit $rc
